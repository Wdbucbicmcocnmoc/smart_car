C251 COMPILER V5.60.0,  Kalman_cal                                                         28/08/22  23:11:03  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE Kalman_cal
OBJECT MODULE PLACED IN .\Out_File\Kalman_cal.obj
COMPILER INVOKED BY: D:\keil5\C251\BIN\C251.EXE Kalman_cal.c XSMALL INTR2 WARNINGLEVEL(3) BROWSE INCDIR(..\..\Libraries\
                    -libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE;..\USER\inc;..\USER\src) DEBUG 
                    -PRINT(.\Out_File\Kalman_cal.lst) TABS(2) OBJECT(.\Out_File\Kalman_cal.obj) 

stmt  level    source

    1          #include "headfile.h"
    2          #include "myfile.h"
    3          
    4          extern int16 icm_gyro_x, icm_gyro_y, icm_gyro_z;
    5          extern int16 icm_acc_x, icm_acc_y, icm_acc_z;
    6          //å¡å°”æ›¼è§£ç®—æ³•åº“
    7          
    8          short aacx,aacy,aacz;   //åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨åŸå§‹æ•°æ® 
    9          short gyrox,gyroy,gyroz;  //é™€èºä»ªåŸå§‹æ•°æ® 
   10          short temperature;      //é™€èºä»ªæ¸©åº¦æ•°æ®
   11          float accel_x;          //Xè½´åŠ é€Ÿåº¦å€¼
   12          float accel_y;          //Yè½´åŠ é€Ÿåº¦å€¼
   13          float accel_z;          //Zè½´åŠ é€Ÿåº¦å€¼
   14          float gyro_xx;            //Xè½´é™€èºä»ªè§’é€Ÿåº¦æ•°æ®
   15          float gyro_yy;            //Yè½´é™€èºä»ªè§’é€Ÿåº¦æ•°æ®
   16          float gyro_zz;            //Zè½´é™€èºä»ªè§’é€Ÿåº¦æ•°æ®
   17          float yaw_raw;          //èˆªçº¿è§’yawåŸå§‹æ•°æ®
   18          float yaw_kalman;       //yawæ»¤æ³¢åæ•°æ®
   19          float pitch_raw;        //ä¿¯ä»°è§’pitchåŸå§‹æ•°æ®
   20          float pitch_kalman;     //pitchæ»¤æ³¢åæ•°æ®
   21          float roll_raw;         //æ¨ªæ»šè§’rollåŸå§‹æ•°æ®
   22          float roll_kalman;      //rollæ»¤æ³¢åæ•°æ®         
   23          
   24          
   25          
   26          //é™€èºä»ªæ•°æ®è®¡ç®—
   27          void Angle_Cal()
   28          {
   29   1        //1. åŸå§‹æ•°æ®è·å–
   30   1        float accx,accy,accz;//ä¸‰æ–¹å‘è§’åŠ é€Ÿåº¦å€¼ 
   31   1        //è·å–åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨æ•°æ®      
   32   1       get_icm20602_accdata_simiic();
   33   1        //è·å¾—é™€èºä»ªæ•°æ®
   34   1        get_icm20602_gyro_simiic();
   35   1        accel_x = icm_acc_x;//xè½´åŠ é€Ÿåº¦å€¼æš‚å­˜
   36   1        accel_y = icm_acc_y;//yè½´åŠ é€Ÿåº¦å€¼æš‚å­˜
   37   1        accel_z = icm_acc_z;//zè½´åŠ é€Ÿåº¦å€¼æš‚å­˜
   38   1        gyro_xx  = icm_gyro_x;//xè½´é™€èºä»ªå€¼æš‚å­˜
   39   1        gyro_yy  = icm_gyro_y;//yè½´é™€èºä»ªå€¼æš‚å­˜
   40   1        gyro_zz  = icm_gyro_z;//zè½´é™€èºä»ªå€¼æš‚å­˜
   41   1        
   42   1        //2.è§’åŠ é€Ÿåº¦åŸå§‹å€¼å¤„ç†è¿‡ç¨‹ 
   43   1        //åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨é…ç½®å¯„å­˜å™¨0X1Cå†…å†™å…¥0x01,è®¾ç½®èŒƒå›´ä¸ºÂ±2gã€‚æ¢ç®—å…³ç³»ï¼š2^16/4 = 16384
             -LSB/g
   44   1        if(accel_x<32764) accx=accel_x/4096.0;//è®¡ç®—xè½´åŠ é€Ÿåº¦
   45   1        else              accx=1-(accel_x-49152)/4096.0;
   46   1        if(accel_y<32764) accy=accel_y/16384.0;//è®¡ç®—yè½´åŠ é€Ÿåº¦
   47   1        else              accy=1-(accel_y-49152)/4096.0;
   48   1        if(accel_z<32764) accz=accel_z/16384.0;//è®¡ç®—zè½´åŠ é€Ÿåº¦
   49   1        else              accz=(accel_z-49152)/4096.0;
   50   1        //åŠ é€Ÿåº¦åæ­£åˆ‡å…¬å¼è®¡ç®—ä¸‰ä¸ªè½´å’Œæ°´å¹³é¢åæ ‡ç³»ä¹‹é—´çš„å¤¹è§’
   51   1        pitch_raw=(atan(accx/accz))*180/3.14;
   52   1        roll_raw=(atan(accy/accz))*180/3.14;
   53   1        //åˆ¤æ–­è®¡ç®—åè§’åº¦çš„æ­£è´Ÿå·                     
   54   1        // if(accel_x<32764) roll_raw = +(roll_raw);
   55   1        // if(accel_x>32764) roll_raw = -(roll_raw);
   56   1        // if(accel_y<32764) pitch_raw = +(pitch_raw);
C251 COMPILER V5.60.0,  Kalman_cal                                                         28/08/22  23:11:03  PAGE 2   

   57   1        // if(accel_y>32764) pitch_raw = -(pitch_raw);
   58   1        
   59   1        //3.è§’é€Ÿåº¦åŸå§‹å€¼å¤„ç†è¿‡ç¨‹
   60   1        //é™€èºä»ªé…ç½®å¯„å­˜å™¨0X1Bå†…å†™å…¥0x18ï¼Œè®¾ç½®èŒƒå›´ä¸ºÂ±2000deg/sã€‚æ¢ç®—å…³ç³»ï¼š2^16/4000=16.4
             -LSB/(Â°/S)
   61   1        ////è®¡ç®—è§’é€Ÿåº¦
   62   1        if(gyro_xx<32768) gyro_xx=-(gyro_xx/16.4);
   63   1        if(gyro_xx>32768) gyro_xx=+(65535-gyro_xx)/16.4;
   64   1        if(gyro_yy<32768) gyro_yy=-(gyro_yy/16.4);
   65   1        if(gyro_yy>32768) gyro_yy=+(65535-gyro_yy)/16.4;
   66   1        if(gyro_zz<32768) gyro_zz=-(gyro_zz/16.4);
   67   1        if(gyro_zz>32768) gyro_zz=+(65535-gyro_zz)/16.4;
   68   1      
   69   1        //4.è°ƒç”¨å¡å°”æ›¼å‡½æ•°
   70   1        Kalman_Cal_Pitch(pitch_raw,gyro_xx);  //å¡å°”æ›¼æ»¤æ³¢è®¡ç®—Xå€¾è§’
   71   1        Kalman_Cal_Roll(roll_raw,gyro_yy);  //å¡å°”æ›¼æ»¤æ³¢è®¡ç®—Yå€¾è§’                                
   72   1      
   73   1      
   74   1      }
   75           
   76          //å¡å°”æ›¼å‚æ•°   
   77          static float Q_angle = 0.0003;    //è§’åº¦æ•°æ®ç½®ä¿¡åº¦ï¼Œè§’åº¦å™ªå£°çš„åæ–¹å·®
   78          static float Q_gyro  = 0.0009;    //è§’é€Ÿåº¦æ•°æ®ç½®ä¿¡åº¦ï¼Œè§’é€Ÿåº¦å™ªå£°çš„åæ–¹å·®  
   79          static float R_angle = 0.8;   //åŠ é€Ÿåº¦è®¡æµ‹é‡å™ªå£°çš„åæ–¹å·®
   80          static float dt      = 0.005;   //é‡‡æ ·å‘¨æœŸå³è®¡ç®—ä»»åŠ¡å‘¨æœŸ5ms
   81          
   82          void Kalman_Cal_Pitch(float acc,float gyro) //å¡å°”æ›¼æ»¤æ³¢pitchè½´è®¡ç®—   
   83          {
   84   1        static float Q_bias;  //Q_bias:é™€èºä»ªçš„åå·®
   85   1        static float K_0, K_1;  //å¡å°”æ›¼å¢ç›Š  K_0:ç”¨äºè®¡ç®—æœ€ä¼˜ä¼°è®¡å€¼  K_1:ç”¨äºè®¡ç®—æœ€ä¼˜ä¼°è®¡å
             -€¼çš„åå·® t_0/1:ä¸­é—´å˜é‡
   86   1        static float PP[2][2] = { { 1, 0 },{ 0, 1 } };//è¿‡ç¨‹åæ–¹å·®çŸ©é˜µPï¼Œåˆå§‹å€¼ä¸ºå•ä½é˜µ
   87   1      
   88   1        /*
   89   1          å¡å°”æ›¼æ»¤æ³¢çš„ä½¿ç”¨æ­¥éª¤
   90   1          (1) é€‰æ‹©çŠ¶æ€é‡ã€è§‚æµ‹é‡
   91   1          (2) æ„å»ºæ–¹ç¨‹
   92   1          (3) åˆå§‹åŒ–å‚æ•°
   93   1          (4) å¸¦å…¥å…¬å¼è¿­ä»£
   94   1          (5) è°ƒèŠ‚è¶…å‚æ•°Pã€Q
   95   1        */
   96   1        /*
   97   1        X(k)ï¼škæ—¶åˆ»ç³»ç»ŸçŠ¶æ€        Z(k)ï¼škæ—¶åˆ»æµ‹é‡å€¼
   98   1        U(k)ï¼škæ—¶åˆ»å¯¹ç³»ç»Ÿæ§åˆ¶é‡    Hï¼šæµ‹é‡ç³»ç»Ÿå‚æ•°
   99   1                                                 æ–¹å·®
  100   1        A/Fï¼šçŠ¶æ€è½¬ç§»çŸ©é˜µ          W(k)ï¼šè¿‡ç¨‹å™ªå£° ----> Q
  101   1                                                 æ–¹å·® 
  102   1        Bï¼šæ§åˆ¶çŸ©é˜µ                V(k)ï¼šæµ‹é‡å™ªå£° ----> R
  103   1        
  104   1                          ç¦»æ•£æ§åˆ¶ç³»ç»Ÿ
  105   1        ç³»ç»Ÿæè¿°ï¼šX(k|k-1) = AX(k-1|k-1) + BU(k) + (W(k))
  106   1        æµ‹é‡å€¼ï¼šZ(k) = HX(k) + V(k)
  107   1        */
  108   1        /*
  109   1        1. å…ˆéªŒä¼°è®¡
  110   1      * * *å…¬å¼1ï¼šX(k|k-1) = AX(k-1|k-1) + BU(k) + (W(k))
  111   1      
  112   1          X = (Angle,Q_bias)
  113   1          A(1,1) = 1,A(1,2) = -dt
  114   1          A(2,1) = 0,A(2,2) = 1
  115   1          æ³¨ï¼šä¸Šä¸‹è¿â€œ[â€ä»£è¡¨çŸ©é˜µ
  116   1          é¢„æµ‹å½“å‰è§’åº¦å€¼ï¼š
  117   1          [ angle ]   [1 -dt][ angle ]   [dt]
  118   1          [ Q_bias] = [0  1 ][ Q_bias] + [ 0] * newGyro(åŠ é€Ÿåº¦è®¡æµ‹é‡å€¼)
  119   1          æ•…
  120   1          angle = angle - Q_bias*dt + newGyro * dt
C251 COMPILER V5.60.0,  Kalman_cal                                                         28/08/22  23:11:03  PAGE 3   

  121   1          Q_bias = Q_bias
  122   1        */
  123   1        pitch_kalman += (gyro - Q_bias) * dt; //çŠ¶æ€æ–¹ç¨‹,è§’åº¦å€¼ç­‰äºä¸Šæ¬¡æœ€ä¼˜è§’åº¦åŠ è§’é€Ÿåº¦å‡é›¶
             -æ¼‚åç§¯åˆ†
  124   1        
  125   1        /*
  126   1        2. é¢„æµ‹åæ–¹å·®çŸ©é˜µ
  127   1      * * *å…¬å¼2ï¼šP(k|k-1)=AP(k-1|k-1)A^T + Q 
  128   1      
  129   1          ç”±å…ˆéªŒä¼°è®¡æœ‰ç³»ç»Ÿå‚æ•°
  130   1              [1 -dt]
  131   1          A = [0  1 ]
  132   1          
  133   1          ç³»ç»Ÿè¿‡ç¨‹åæ–¹å·®å™ªå£°Qå®šä¹‰ï¼š
  134   1          | cov(angle,angle)  cov(Q_bias,angle) |
  135   1          | cov(angle,Q_bias) cov(Q_bias,Q_bias)|
  136   1             è§’åº¦å™ªå£°å’Œè§’é€Ÿåº¦æ¼‚ç§»å™ªå£°ç›¸äº’ç‹¬ç«‹
  137   1          | D( angle )        0    |
  138   1        = |     0       D( Q_bias )|
  139   1          åˆQ_angleå’ŒQ_biasçš„æ–¹å·®ä¸ºå¸¸æ•°ï¼Œ
  140   1          å¯ç”±ç»éªŒæˆ–è®¡ç®—å¾—å‡º
  141   1          
  142   1          ä»¤D( angle )  = Q_angle 
  143   1            D( Q_bias ) = Q_gyro 
  144   1            
  145   1          è®¾ä¸Šä¸€æ¬¡é¢„æµ‹åæ–¹å·®çŸ©é˜µä¸ºP(k-1)
  146   1                            |a(k-1)  b(k-1)|
  147   1                            |c(k-1)  d(k-1)|
  148   1          æœ¬æ¬¡é¢„æµ‹åæ–¹å·®çŸ©é˜µP(k)
  149   1                            |a(k)  b(k)|
  150   1                            |c(k)  d(k)|
  151   1          ç”±å…¬å¼2ï¼šP(k|k-1)=AP(k-1|k-1)A^T + Q å¾—
  152   1          |a(k)  b(k)|    |1 -dt| |a(k-1) b(k-1)| |1   0|   | D( angle )        0    |
  153   1          |c(k)  d(k)| =  |0  1 | |c(k-1) d(k-1)| |-dt 1| + |     0       D( Q_bias )|
  154   1        
  155   1          è¿›ä¸€æ­¥å¾—
  156   1          |a(k)  b(k)|    |a(k-1) - [c(k-1) + b(k-1)]*dt + d(dt)^2    b(k-1) - d(k-1)*dt|   | D( angle )        0    |
  157   1          |c(k)  d(k)| =  |       c(k-1) - d(k-1)*dt                          d(k-1)    | + |     0       D( Q_bias )|
  158   1          
  159   1          ç”±äºdt^2å¤ªå°ï¼Œæ•…dt^2çœç•¥
  160   1        */
  161   1        
  162   1        PP[0][0] = PP[0][0] + Q_angle - (PP[0][1] + PP[1][0])*dt;
  163   1        PP[0][1] = PP[0][1] - PP[1][1]*dt;
  164   1        PP[1][0] = PP[1][0] - PP[1][1]*dt;
  165   1        PP[1][1] = PP[1][1] + Q_gyro;
  166   1        
  167   1        /*
  168   1          3. å»ºç«‹æµ‹é‡æ–¹ç¨‹
  169   1            ç³»ç»Ÿæµ‹é‡æ–¹ç¨‹ Z(k) = HX(k) + V(k)
  170   1            ç³»ç»Ÿæµ‹é‡ç³»æ•° H = [1, 0]
  171   1            å› ä¸ºé™€èºä»ªè¾“å‡ºè‡ªå¸¦å™ªå£°
  172   1            æ‰€ä»¥
  173   1            measure = newAngle
  174   1        */
  175   1        
  176   1        /*
  177   1          4. è®¡ç®—å¡å°”æ›¼å¢ç›Š
  178   1      * * *å…¬å¼3ï¼šKg(k)= P(k|k-1)H^T/(HP(k|k-1)H^T+R)
  179   1              Kg = (K_0,K_1) å¯¹åº”angle,Q_biaså¢ç›Š
  180   1              H = (1,0)
  181   1        */
  182   1        K_0 = PP[0][0] / (PP[0][0] + R_angle);
  183   1        K_1 = PP[1][0] / (PP[0][0] + R_angle);
  184   1      
  185   1        /*
C251 COMPILER V5.60.0,  Kalman_cal                                                         28/08/22  23:11:03  PAGE 4   

  186   1          5. è®¡ç®—å½“å‰æœ€ä¼˜åŒ–ä¼°è®¡å€¼
  187   1      * * *å…¬å¼4ï¼šX(k|k) = X(k|k-1) + kg(k)[z(k) - HX(k|k-1)]
  188   1          angle = angle + K_0*(newAngle - angle)
  189   1          Q_bias = Q_bias + K_1*(newAngle - angle)
  190   1        */
  191   1          
  192   1        pitch_kalman = pitch_kalman + K_0 * (acc - pitch_kalman);
  193   1        Q_bias = Q_bias + K_1 * (acc - pitch_kalman);
  194   1      
  195   1        /*
  196   1          6. æ›´æ–°åæ–¹å·®çŸ©é˜µ
  197   1      * * *å…¬å¼5ï¼šP(k|k)=[I-Kg(k)H]P(k|k-1)
  198   1        */
  199   1        PP[0][0] = PP[0][0] - K_0 * PP[0][0];
  200   1        PP[0][1] = PP[0][1] - K_0 * PP[0][1];
  201   1        PP[1][0] = PP[1][0] - K_1 * PP[0][0];
  202   1        PP[1][1] = PP[1][1] - K_1 * PP[0][1];
  203   1      
  204   1      }
  205          
  206          void Kalman_Cal_Roll(float acc,float gyro) //å¡å°”æ›¼æ»¤æ³¢rollè½´è®¡ç®—       
  207          {
  208   1        static float Q_bias;  //Q_bias:é™€èºä»ªçš„åå·®  Angle_err:è§’åº¦åé‡ 
  209   1        static float K_0, K_1;  //å¡å°”æ›¼å¢ç›Š  K_0:ç”¨äºè®¡ç®—æœ€ä¼˜ä¼°è®¡å€¼  K_1:ç”¨äºè®¡ç®—æœ€ä¼˜ä¼°è®¡å
             -€¼çš„åå·® t_0/1:ä¸­é—´å˜é‡
  210   1        static float PP[2][2] = { { 1, 0 },{ 0, 1 } };//è¿‡ç¨‹åæ–¹å·®çŸ©é˜µPï¼Œåˆå§‹å€¼ä¸ºå•ä½é˜µ
  211   1        roll_kalman += (gyro - Q_bias) * dt; //çŠ¶æ€æ–¹ç¨‹,è§’åº¦å€¼ç­‰äºä¸Šæ¬¡æœ€ä¼˜è§’åº¦åŠ è§’é€Ÿåº¦å‡é›¶æ
             -¼‚åç§¯åˆ†
  212   1        PP[0][0] = PP[0][0] + Q_angle - (PP[0][1] + PP[1][0])*dt;
  213   1        PP[0][1] = PP[0][1] - PP[1][1]*dt;
  214   1        PP[1][0] = PP[1][0] - PP[1][1]*dt;
  215   1        PP[1][1] = PP[1][1] + Q_gyro;
  216   1        K_0 = PP[0][0] / (PP[0][0] + R_angle);
  217   1        K_1 = PP[1][0] / (PP[0][0] + R_angle);
  218   1        roll_kalman = roll_kalman + K_0 * (acc - roll_kalman);
  219   1        Q_bias = Q_bias + K_1 * (acc - roll_kalman);
  220   1        PP[0][0] = PP[0][0] - K_0 * PP[0][0];
  221   1        PP[0][1] = PP[0][1] - K_0 * PP[0][1];
  222   1        PP[1][0] = PP[1][0] - K_1 * PP[0][0];
  223   1        PP[1][1] = PP[1][1] - K_1 * PP[0][1];
  224   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1218     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       134          8
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        72     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
